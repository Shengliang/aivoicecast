
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ----------------------------------------------------------------------
    // Global Default: Deny everything unless explicitly allowed
    // ----------------------------------------------------------------------
    match /{document=**} {
      allow read, write: if false;
    }

    // ----------------------------------------------------------------------
    // USERS COLLECTION
    match /users/{userId} {
      allow read: if isAuthenticated(); 
      allow create: if isOwner(userId);
      // Allow owner to update profile OR any auth user to update ONLY the followers list (e.g. Follow button)
      allow update: if isOwner(userId) || (isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['followers'])); 
    }

    // ----------------------------------------------------------------------
    // GROUPS COLLECTION
    match /groups/{groupId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;

      match /messages/{msgId} {
        allow read, write: if isAuthenticated();
      }
    }

    // ----------------------------------------------------------------------
    // WORKPLACE CHAT
    match /chat_channels/{channelId} {
      allow read, write: if isAuthenticated();
      
      match /messages/{msgId} {
        allow read, write: if isAuthenticated();
      }
    }

    // ----------------------------------------------------------------------
    // PODCAST CHANNELS
    match /channels/{channelId} {
      allow read: if true; 
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && (resource.data.ownerId == request.auth.uid || resource.data.ownerId == null);
      
      match /lectures/{lectureId} { allow read, write: if true; }
      match /comments/{commentId} { allow read, write: if true; }
      match /meta/{docId} { allow read, write: if true; }
    }

    // ----------------------------------------------------------------------
    // GLOBAL STATS (New)
    match /stats/{statId} {
      allow read: if true; 
      allow write: if isAuthenticated();
    }

    // ----------------------------------------------------------------------
    // CUSTOMERS (STRIPE)
    match /customers/{uid} {
      allow create, read, update, delete: if isOwner(uid);

      match /checkout_sessions/{id} {
        allow read, write: if isOwner(uid);
      }
      match /subscriptions/{id} {
        allow read: if isOwner(uid);
      }
      match /payments/{id} {
        allow read: if isOwner(uid);
      }
      match /portal_sessions/{id} {
        allow read, write: if isOwner(uid);
      }
    }

    // ----------------------------------------------------------------------
    // SOCIAL FEATURES
    match /invitations/{inviteId} { allow read, write: if isAuthenticated(); }
    match /bookings/{bookingId} { allow read, write: if isAuthenticated(); }
    match /discussions/{discussionId} { allow read, write: if isAuthenticated(); }
    match /recordings/{recordingId} { allow read, write: if isAuthenticated(); }
    match /saved_words/{wordId} { allow read, write: if isAuthenticated(); }
    match /activity_logs/{logId} { allow read, create: if isAuthenticated(); }
    
    // ----------------------------------------------------------------------
    // CAREER CENTER
    // ----------------------------------------------------------------------
    match /career_applications/{appId} {
      allow create: if isAuthenticated();
      // Allow all members to read resumes (Talent Pool)
      allow read: if isAuthenticated(); 
    }
    
    match /job_postings/{jobId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.postedBy == request.auth.uid;
    }

    // ----------------------------------------------------------------------
    // COLLABORATION
    match /code_projects/{projectId} {
      // Allow if:
      // 1. Project doesn't exist yet (create)
      // 2. Project is Public (accessLevel != 'restricted')
      // 3. User is Owner
      // 4. User is in allowedUserIds list
      allow read, write: if resource == null || 
                            resource.data.accessLevel != 'restricted' || 
                            (request.auth != null && (
                                resource.data.ownerId == request.auth.uid || 
                                (resource.data.allowedUserIds != null && request.auth.uid in resource.data.allowedUserIds)
                            ));
    }
    match /whiteboards/{boardId} {
      allow read, write: if true;
    }

    // ----------------------------------------------------------------------
    // BLOGS
    match /blog_posts/{postId} { 
      allow read: if true; 
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && (resource.data.authorId == request.auth.uid || request.auth.uid == 'admin-uid');
    }
    
    match /blogs/{blogId} { allow read: if true; allow write: if isAuthenticated(); }

    // ----------------------------------------------------------------------
    // PRIVATE DATA
    match /private_data/{documentId} {
      allow read, delete: if isOwner(resource.data.ownerId);
      allow create: if isOwner(request.resource.data.ownerId) &&
                       request.resource.data.status in ['pending', 'approved', 'rejected'];
      allow update: if isOwner(resource.data.ownerId) &&
                       request.resource.data.status in ['pending', 'approved', 'rejected'] &&
                       request.resource.data.ownerId == resource.data.ownerId;
    }
  }
}